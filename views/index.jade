#fb-root
.container
  .searchMain
    h1 Who Will I Know There?
    br
    form.well.form-inline(id='search', name='search', action='/login')
      label
        h4(style='margin-right: 10px; margin-bottom:5px;')
          | I'm looking for friends near
      input.input-xlarge.search-query(id='place', name='place', placeholder='Enter a city name (e.g., San Francisco)', style='margin-right: 10px; margin-bottom:5px;')
      button.btn.btn-primary(type='submit')
        | Find Friends!
    br
    p(class='loading') Searching your facebook graph...
    img(class='loading', src="/img/loading.gif", alt="Loading friends (may take a while)")
    p(class='done_loading') Done.
    br
    script
      $(document).ready(function(){
        $('.done_loading').hide();
        $('.loading')
          .hide()
          .ajaxStart(function(){
            $('.loading').delay(500).show();
          })
          .ajaxStop(function(){
            $('.loading').delay(500).hide();
            $('.done_loading').delay(500).show();
          });
      });

    - if(access_token)
      ul#people
      script
        var access_token = "#{access_token}";
        var place = "#{place}";
        var appId = "#{appId}";
        console.log("logged in.");
        console.log(access_token);
        console.log(place);
        console.log(appId);

        $(document).ready(function(){
          $('#place').val(place); // update searched value
          
            
          // Helper functions
          
          var isNearby = function(a, b){
            return (a.toLowerCase().indexOf(b.toLowerCase()) !== -1);
          }

          var makePerson = function(friend){
            console.log(friend);
            var id = friend.username || friend.id;
            console.log("id = %s", id);
            var res = '<li>' +
                        '<a href="https://facebook.com/'+id+'">' +
                          '<div class="person">' +
                            '<img src="https://graph.facebook.com/'+id+'/picture?type=normal"/>' +
                            '<h3>' + friend.name + '</h3>' +
                          '</div>' +
                        '</a>' +
                      '</li>';
            return res;
          }
          
          var FB = function(path, cb){
            $.getJSON('/fb/'+path, cb);
          }

          // Perform the search
          FB('/me', function(data){
            var me = data;
            FB('/me/friends', function(data){
              var friends = data.data;
              console.log("Looking through "+friends.length+" friends");
              
              var people = $('ul#people');
              _.each(friends, function(friend, i, l){
                var id = friend.id;
                var name = friend.name;
                FB('/'+id, function(friend_info){
                  var nearby = false;
                  if(friend_info.hometown && friend_info.hometown.name &&
                     isNearby(friend_info.hometown.name, place)){
                    nearby = true;
                  }
                  else if(friend_info.location && friend_info.location.name &&
                          isNearby(friend_info.location.name, place)){
                    nearby = true;
                  }
                  if(nearby){
                    console.log("%s is nearby", friend_info.name);
                    people.append(makePerson(friend_info));
                  }
                });
              });
            });
          });
        });
